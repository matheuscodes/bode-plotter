name: SonarQube
on:
        push:
                branches:
                        - master
        pull_request:
                types: [opened, synchronize, reopened]
jobs:
        build:
                name: Build and analyze
                runs-on: ubuntu-latest
                steps:
                        - uses: actions/checkout@v4
                          with:
                                  fetch-depth: 0
                        - name: Set up JDK 8
                          uses: actions/setup-java@v4
                          with:
                                  java-version: 8
                                  distribution: 'temurin'
                        - name: Cache SonarQube packages
                          uses: actions/cache@v4
                          with:
                                  path: ~/.sonar/cache
                                  key: ${{ runner.os }}-sonar
                                  restore-keys: ${{ runner.os }}-sonar
                        - name: Cache Maven packages
                          uses: actions/cache@v4
                          with:
                                  path: ~/.m2
                                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                                  restore-keys: ${{ runner.os }}-m2
                        - name: Run tests
                          run: mvn clean verify

                        - name: Set up Java 17 for Sonar
                          uses: actions/setup-java@v4
                          with:
                            java-version: '17'
                            distribution: 'temurin'
                        - name: Run SonarCloud analysis
                          if: github.actor != 'dependabot[bot]'
                          env:
                            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                          run: |
                            mvn sonar:sonar \
                              -Dsonar.projectKey=matheuscodes_bode-plotter \
                              -Dsonar.organization=matheuscodes-analysed \
                              -Dsonar.host.url=https://sonarcloud.io \
                              -Dsonar.token=${SONAR_TOKEN} \
                              -Dsonar.java.binaries=target \
                              -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml